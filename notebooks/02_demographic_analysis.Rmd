---
title: "Coral Demographic Analysis"
author: "MCR LTER Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 12,
  fig.height = 8,
  dpi = 300
)

library(here)
library(tidyverse)
library(knitr)
library(patchwork)
library(scales)

# Source utility functions
source(here("scripts/R/utils.R"))
source(here("scripts/R/02_transform_data.R"))
```

# Overview

This notebook analyzes demographic patterns in the coral monitoring dataset:

- Population dynamics over time
- Recruitment rates
- Mortality rates
- Growth rates
- Size-frequency distributions

---

# 1. Load Processed Data

```{r load-data}
# Load the tidy (long-format) dataset created by transform script
coral_long <- read_csv(here("data/processed/coral_long_format.csv"))

cat("Total observations:", nrow(coral_long), "\n")
cat("Unique colonies:", n_distinct(coral_long$coral_id), "\n")
cat("Years:", paste(range(coral_long$year), collapse = " - "), "\n")

glimpse(coral_long)
```

---

# 2. Population Dynamics

## 2.1 Total Population Over Time

```{r population-time-series}
# Count colonies present each year (Status != "D" for dead)
population_by_year <- coral_long %>%
  filter(!is.na(status), status != "D") %>%
  count(year, genus) %>%
  group_by(year) %>%
  mutate(total = sum(n))

# Total population trajectory
pop_total <- population_by_year %>%
  group_by(year) %>%
  summarise(total = sum(n))

ggplot(pop_total, aes(x = year, y = total)) +
  geom_line(linewidth = 1.2, color = "steelblue") +
  geom_point(size = 3, color = "steelblue") +
  scale_x_continuous(breaks = 2013:2023) +
  labs(title = "Total Coral Colony Population Over Time",
       subtitle = "MCR LTER Back Reef Transects 1-2",
       x = "Year", y = "Number of Live Colonies") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank())

# Save figure
ggsave(here("outputs/figures/population_time_series.png"),
       width = 10, height = 6, dpi = 300)
```

## 2.2 Population by Genus

```{r population-by-genus}
ggplot(population_by_year, aes(x = year, y = n, color = genus, group = genus)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  scale_x_continuous(breaks = 2013:2023) +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Population Dynamics by Genus",
       x = "Year", y = "Number of Live Colonies",
       color = "Genus") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        legend.position = "bottom")

ggsave(here("outputs/figures/population_by_genus.png"),
       width = 10, height = 6, dpi = 300)
```

---

# 3. Recruitment Analysis

```{r recruitment-analysis}
# Identify recruits as colonies that appear for the first time
# (first non-NA observation for each colony)

first_observation <- coral_long %>%
  filter(!is.na(status)) %>%
  group_by(coral_id) %>%
  arrange(year) %>%
  slice(1) %>%
  ungroup()

# Recruits are those first observed after 2013 (baseline year)
recruits <- first_observation %>%
  filter(year > 2013) %>%
  count(year, genus, name = "recruits")

# Annual recruitment rates
recruitment_summary <- recruits %>%
  group_by(year) %>%
  summarise(total_recruits = sum(recruits))

kable(recruitment_summary, caption = "Annual Recruitment Events")

# Visualization
ggplot(recruits, aes(x = year, y = recruits, fill = genus)) +
  geom_col(position = "stack") +
  scale_x_continuous(breaks = 2014:2023) +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Coral Recruitment Over Time",
       subtitle = "New colonies appearing in transects",
       x = "Year", y = "Number of Recruits",
       fill = "Genus") +
  theme_minimal() +
  theme(legend.position = "bottom")

ggsave(here("outputs/figures/recruitment_time_series.png"),
       width = 10, height = 6, dpi = 300)
```

---

# 4. Mortality Analysis

```{r mortality-analysis}
# Identify deaths (Status = "D" or Fate indicating death)
# For each colony, find the last live observation and first dead observation

mortality_events <- coral_long %>%
  filter(!is.na(status)) %>%
  group_by(coral_id) %>%
  arrange(year) %>%
  mutate(
    died = status == "D" | grepl("death|dead", fate, ignore.case = TRUE),
    death_year = ifelse(any(died), min(year[died]), NA)
  ) %>%
  filter(!is.na(death_year), year == death_year) %>%
  ungroup() %>%
  count(year, genus, name = "deaths")

mortality_summary <- mortality_events %>%
  group_by(year) %>%
  summarise(total_deaths = sum(deaths))

kable(mortality_summary, caption = "Annual Mortality Events")

# Visualization
ggplot(mortality_events, aes(x = year, y = deaths, fill = genus)) +
  geom_col(position = "stack") +
  scale_x_continuous(breaks = 2013:2023) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Coral Mortality Over Time",
       x = "Year", y = "Number of Deaths",
       fill = "Genus") +
  theme_minimal() +
  theme(legend.position = "bottom")

ggsave(here("outputs/figures/mortality_time_series.png"),
       width = 10, height = 6, dpi = 300)
```

---

# 5. Net Population Change

```{r net-change}
# Combine recruitment and mortality
demographic_rates <- full_join(
  recruitment_summary,
  mortality_summary,
  by = "year"
) %>%
  replace_na(list(total_recruits = 0, total_deaths = 0)) %>%
  mutate(net_change = total_recruits - total_deaths)

kable(demographic_rates, caption = "Demographic Rates Summary")

# Visualization
demographic_long <- demographic_rates %>%
  pivot_longer(cols = c(total_recruits, total_deaths),
               names_to = "event", values_to = "count") %>%
  mutate(event = recode(event,
                        total_recruits = "Recruitment",
                        total_deaths = "Mortality"))

ggplot(demographic_long, aes(x = year, y = count, fill = event)) +
  geom_col(position = "dodge") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_x_continuous(breaks = 2014:2023) +
  scale_fill_manual(values = c("Recruitment" = "darkgreen", "Mortality" = "darkred")) +
  labs(title = "Recruitment vs Mortality",
       x = "Year", y = "Count",
       fill = "Event") +
  theme_minimal() +
  theme(legend.position = "bottom")

ggsave(here("outputs/figures/recruitment_vs_mortality.png"),
       width = 10, height = 6, dpi = 300)
```

---

# 6. Growth Rate Analysis

```{r growth-analysis}
# Calculate growth rates as change in size between consecutive years
# Size metric: geometric mean diameter or volume proxy

coral_growth <- coral_long %>%
  filter(!is.na(diam1), !is.na(diam2), !is.na(height)) %>%
  mutate(
    geom_mean_diam = sqrt(diam1 * diam2),
    volume_proxy = (diam1 * diam2 * height) / 6
  ) %>%
  group_by(coral_id, genus) %>%
  arrange(year) %>%
  mutate(
    size_lag = lag(geom_mean_diam),
    growth_rate = (geom_mean_diam - size_lag) / size_lag,  # Proportional growth
    growth_abs = geom_mean_diam - size_lag  # Absolute growth (cm)
  ) %>%
  filter(!is.na(growth_rate)) %>%
  ungroup()

# Summary statistics
growth_summary <- coral_growth %>%
  group_by(genus) %>%
  summarise(
    n_obs = n(),
    mean_growth_rate = mean(growth_rate, na.rm = TRUE),
    median_growth_rate = median(growth_rate, na.rm = TRUE),
    sd_growth_rate = sd(growth_rate, na.rm = TRUE),
    mean_growth_cm = mean(growth_abs, na.rm = TRUE)
  )

kable(growth_summary, digits = 3, caption = "Growth Rate Statistics by Genus")

# Visualize growth rate distributions
ggplot(coral_growth, aes(x = growth_rate, fill = genus)) +
  geom_histogram(bins = 50, alpha = 0.7) +
  facet_wrap(~genus, scales = "free_y") +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Growth Rate Distributions by Genus",
       subtitle = "Proportional change in diameter between years",
       x = "Growth Rate (proportion)", y = "Count") +
  theme_minimal() +
  theme(legend.position = "none")

ggsave(here("outputs/figures/growth_rate_distributions.png"),
       width = 12, height = 8, dpi = 300)
```

---

# 7. Size-Frequency Distributions

```{r size-frequency}
# Size distributions by year and genus

size_data <- coral_long %>%
  filter(!is.na(diam1), !is.na(diam2)) %>%
  mutate(geom_mean_diam = sqrt(diam1 * diam2))

# Overall size distribution
ggplot(size_data, aes(x = geom_mean_diam, fill = genus)) +
  geom_histogram(bins = 40, alpha = 0.7, position = "identity") +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Colony Size Distribution (All Years)",
       x = "Geometric Mean Diameter (cm)", y = "Count",
       fill = "Genus") +
  theme_minimal()

ggsave(here("outputs/figures/size_distribution_overall.png"),
       width = 10, height = 6, dpi = 300)

# Size distribution over time
ggplot(size_data, aes(x = geom_mean_diam, fill = genus)) +
  geom_histogram(bins = 30, alpha = 0.7) +
  facet_wrap(~year, ncol = 4) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Colony Size Distribution Over Time",
       x = "Geometric Mean Diameter (cm)", y = "Count",
       fill = "Genus") +
  theme_minimal() +
  theme(legend.position = "bottom")

ggsave(here("outputs/figures/size_distribution_by_year.png"),
       width = 14, height = 10, dpi = 300)
```

---

# 8. Summary Multi-Panel Figure

```{r summary-figure, fig.width=14, fig.height=10}
# Create publication-quality multi-panel figure

p1 <- ggplot(pop_total, aes(x = year, y = total)) +
  geom_line(linewidth = 1.2, color = "steelblue") +
  geom_point(size = 3, color = "steelblue") +
  scale_x_continuous(breaks = seq(2013, 2023, 2)) +
  labs(title = "A. Total Population",
       x = "Year", y = "Live Colonies") +
  theme_minimal()

p2 <- ggplot(demographic_long, aes(x = year, y = count, fill = event)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("Recruitment" = "darkgreen", "Mortality" = "darkred")) +
  labs(title = "B. Recruitment vs Mortality",
       x = "Year", y = "Count", fill = "") +
  theme_minimal() +
  theme(legend.position = "bottom")

p3 <- ggplot(population_by_year, aes(x = year, y = n, fill = genus)) +
  geom_area(alpha = 0.7) +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "C. Population by Genus",
       x = "Year", y = "Live Colonies", fill = "Genus") +
  theme_minimal() +
  theme(legend.position = "bottom")

p4 <- ggplot(coral_growth %>% filter(abs(growth_rate) < 1),
             aes(x = genus, y = growth_rate, fill = genus)) +
  geom_boxplot(alpha = 0.7) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "D. Growth Rates by Genus",
       x = "Genus", y = "Growth Rate (proportion)") +
  theme_minimal() +
  theme(legend.position = "none")

# Combine panels
(p1 + p2) / (p3 + p4)

ggsave(here("outputs/figures/demographic_summary_4panel.png"),
       width = 14, height = 10, dpi = 300)
```

---

# Session Info

```{r session-info}
sessionInfo()
```
